!function(){"use strict";const t={containerId:"tree-container",data:[],idAlias:"id",parentIdAlias:"parent_id",collapseChild:!1,template:"<div class='node'>[data:text]</div>",nodeWidth:160,nodeHeight:100,nodePadding:40,levelHeight:150,horizontalSpacing:200,backgroundPattern:"dots",backgroundColor:"#f9f9f9",patternColor:"#cccccc",nodeDraggable:!1};class e{constructor(t){this.options=t}buildTree(t){const e=new Map,{idAlias:n,parentIdAlias:i}=this.options,s=t.map((t=>({...t,id:t[n||"id"],parent_id:t[i||"parent_id"],collapsed:!1,data:t,parent:null,children:[],manuallyPositioned:!1,current_node_element:document.createElementNS("http://www.w3.org/2000/svg","g"),parent_node_element:null,child_node_elements:[],isSelected:!1})));s.forEach((t=>e.set(t.id,t)));const o=[];return s.forEach((t=>{if(null==t.parent_id)t.parent=null,o.push(t);else{const n=e.get(t.parent_id);n&&(t.parent=n,t.parent_node_element=n.current_node_element,n.child_node_elements.push(t.current_node_element),n.children.push(t))}})),o}getAllNodes(t){let e=[];const n=t=>{e.push(t),t.children.forEach(n)};return t.forEach(n),e}processTemplate(t,e){return t.replace(/\[data:(.+?)\]/g,((t,n)=>{var i,s;return(null==(s=null==(i=e.data)?void 0:i.data)?void 0:s[n])??""}))}}class n{constructor(t){this.options=t}createDotPattern(){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","pattern");e.setAttribute("id","dotPattern"),e.setAttribute("width","20"),e.setAttribute("height","20"),e.setAttribute("patternUnits","userSpaceOnUse");const n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx","2"),n.setAttribute("cy","2"),n.setAttribute("r","0.5"),n.setAttribute("fill",this.options.patternColor||"#cccccc"),e.appendChild(n),t.appendChild(e),t}createGridPattern(){const t=document.createElementNS("http://www.w3.org/2000/svg","defs"),e=document.createElementNS("http://www.w3.org/2000/svg","pattern");e.setAttribute("id","gridPattern"),e.setAttribute("width","20"),e.setAttribute("height","20"),e.setAttribute("patternUnits","userSpaceOnUse");const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1","0"),n.setAttribute("y1","0"),n.setAttribute("x2","20"),n.setAttribute("y2","0"),n.setAttribute("stroke",this.options.patternColor||"#cccccc"),n.setAttribute("stroke-width","0.5"),n.setAttribute("stroke-dasharray","3, 3");const i=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttribute("x1","0"),i.setAttribute("y1","0"),i.setAttribute("x2","0"),i.setAttribute("y2","20"),i.setAttribute("stroke",this.options.patternColor||"#cccccc"),i.setAttribute("stroke-width","0.5"),i.setAttribute("stroke-dasharray","3, 3"),e.appendChild(n),e.appendChild(i),t.appendChild(e),t}applyBackgroundPattern(t){if("none"===this.options.backgroundPattern)return;let e,n;"dots"===this.options.backgroundPattern?(e=this.createDotPattern(),n="dotPattern"):(e=this.createGridPattern(),n="gridPattern"),t.appendChild(e);const i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("width","100%"),i.setAttribute("height","100%"),i.setAttribute("fill",`url(#${n})`),t.appendChild(i)}}class i{constructor(t){this.options=t}createSCurve(t,e,n,i){const s=i-e;return`M ${t} ${e} C ${t} ${e+.5*s}, ${n} ${i-.5*s}, ${n} ${i}`}drawConnectionLines(t,e,n){t.forEach((t=>{if(t.parent_id&&e.get(t.parent_id)){const i=e.get(t.parent_id);if(i&&!i.collapsed){const e=document.createElementNS("http://www.w3.org/2000/svg","path"),s=this.options.nodeWidth/2,o=(i.x||0)+s,r=(i.y||0)+this.options.nodeHeight,a=(t.x||0)+s,d=t.y||0,h=this.createSCurve(o,r,a,d);e.setAttribute("d",h),e.setAttribute("stroke","#ccc"),e.setAttribute("stroke-width","2"),e.setAttribute("fill","none"),e.setAttribute("data-from",String(i.id)),e.setAttribute("data-to",String(t.id)),n.appendChild(e)}}}))}updateConnections(t,e,n){if(t.children.forEach((e=>{if(!t.collapsed){const i=n.querySelector(`path[data-from="${t.id}"][data-to="${e.id}"]`);if(i){const n=this.options.nodeWidth/2,s=(t.x||0)+n,o=(t.y||0)+this.options.nodeHeight,r=(e.x||0)+n,a=e.y||0,d=this.createSCurve(s,o,r,a);i.setAttribute("d",d)}}})),t.parent_id){const i=e.get(t.parent_id);if(i&&!i.collapsed){const e=n.querySelector(`path[data-from="${i.id}"][data-to="${t.id}"]`);if(e){const n=this.options.nodeWidth/2,s=(i.x||0)+n,o=(i.y||0)+this.options.nodeHeight,r=(t.x||0)+n,a=t.y||0,d=this.createSCurve(s,o,r,a);e.setAttribute("d",d)}}}}}class s{constructor(t,e,n){this.options=t,this.connectionRenderer=e,this.treeBuilder=n}setupNodeGroup(t){t.current_node_element.setAttribute("class","node-group"),t.current_node_element.setAttribute("data-id",String(t.id)),t.current_node_element.setAttribute("transform",`translate(${t.x||0}, ${t.y||0})`)}setupNodeDragHandle(t){const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("width",String(this.options.nodeWidth)),e.setAttribute("height",String(this.options.nodeHeight)),e.setAttribute("fill","transparent"),e.setAttribute("class","drag-handle"),e.setAttribute("cursor","move"),t.current_node_element.appendChild(e)}setupNodeContent(t){const e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");e.setAttribute("width",String(this.options.nodeWidth)),e.setAttribute("height",String(this.options.nodeHeight));const n=document.createElement("div");n.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),n.innerHTML=this.treeBuilder.processTemplate(this.options.template,t),n.style.cssText="\n\t\t  font-family: sans-serif;\n\t\t  background: white;\n\t\t  border: 1px solid #ccc;\n\t\t  border-radius: 6px;\n\t\t  padding: 10px;\n\t\t  box-shadow: 0 2px 5px rgba(0,0,0,0.1);\n\t\t  width: 100%;\n\t\t  height: 100%;\n\t\t  box-sizing: border-box;\n\t\t  overflow: auto;\n\t\t  display: flex;\n\t\t  object-fit: contain;\n\t\t  flex-direction: column;\n\t\t  position: relative;\n\t\t  item-align: center;\n\t\t  justify-content: center;\n\t  ",this.options.collapseChild&&t.children.length>0&&this.addCollapseButton(t,n),e.appendChild(n),t.current_node_element.appendChild(e)}addCollapseButton(t,e){const n=document.createElement("div");n.style.cssText="\n\t\t  display: flex;\n\t\t  justify-content: center;\n\t\t  width: 100%;\n\t  ";const i=document.createElement("button");i.className="collapse-btn",i.innerHTML=t.collapsed?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',i.title=t.collapsed?"Expand children":"Collapse children",i.style.cssText="\n\t\t  margin-top: 8px;\n\t\t  padding: 4px 6px;\n\t\t  font-size: 12px;\n\t\t  background:rgb(246, 238, 226);\n\t\t  color: black;\n\t\t  border: none;\n\t\t  border-radius: 4px;\n\t\t  cursor: pointer;\n\t  ",i.onclick=e=>{e.stopPropagation();const n=new CustomEvent("node:toggle-collapse",{bubbles:!0,detail:{nodeId:t.id}});i.dispatchEvent(n)},n.appendChild(i),e.appendChild(n)}adjustNodeHeight(t){const e=t.current_node_element.querySelector("div"),n=t.current_node_element.querySelector("foreignObject"),i=t.current_node_element.querySelector("rect");requestAnimationFrame((()=>{const t=e.getBoundingClientRect().height,s=Math.max(t,40);n.setAttribute("height",String(s)),i.setAttribute("height",String(s))}))}drawNodes(t,e){t.forEach((t=>{this.setupNodeGroup(t),this.setupNodeDragHandle(t),this.setupNodeContent(t),e.appendChild(t.current_node_element),this.options.nodeHeight<=0&&this.adjustNodeHeight(t)}))}}class o{constructor(t){this.options=t}layoutTree(t){const{levelHeight:e,horizontalSpacing:n,nodePadding:i}=this.options;let s=[];const o=(t,i=0,r=0)=>{if(t.manuallyPositioned&&void 0!==t.x&&void 0!==t.y){let e=0;return t.collapsed||t.children.forEach((t=>{const n=o(t,i+1,r+e);e+=n.width})),s.push(t),{node:t,width:Math.max(n||200,e)}}if(!t.children.length||t.collapsed)return t.x=r,t.y=i*(e||150),t.origX=r,t.origY=i*(e||150),s.push(t),{node:t,width:n||200};let a=0;const d=[];for(const e of t.children){const t=o(e,i+1,r+a);d.push(t),a+=t.width}0===a&&(a=n||200);const h=d[0].node,c=d[d.length-1].node,l=h.x||0,p=l+((c.x||0)+(this.options.nodeWidth||160)-l)/2-(this.options.nodeWidth||160)/2;return t.x=p,t.y=i*(e||150),t.origX=p,t.origY=i*(e||150),s.push(t),{node:t,width:a}};let r=0;t.forEach((t=>{const e=o(t,0,r);r+=e.width+(i||40)}));const a=Math.min(...s.map((t=>t.x||0)));return a<0&&s.forEach((t=>{void 0!==t.x&&(t.x-=a),void 0!==t.origX&&(t.origX-=a)})),s}calculateTreeBounds(t){if(0===t.length)return{minX:0,minY:0,maxX:0,maxY:0};let e=1/0,n=1/0,i=-1/0,s=-1/0;return t.forEach((t=>{void 0!==t.x&&(e=Math.min(e,t.x),i=Math.max(i,t.x+(this.options.nodeWidth||160))),void 0!==t.y&&(n=Math.min(n,t.y),s=Math.max(s,t.y+(this.options.nodeHeight||100)))})),{minX:e,minY:n,maxX:i,maxY:s}}}class r{constructor(t){this.options=t;const e=document.getElementById(this.options.containerId);if(!e)throw new Error(`Container with ID "${this.options.containerId}" not found`);this.container=e}renderActionButtons(t,e,n,i){const s=document.createElement("button"),o=document.createElement("button"),r=document.createElement("button"),a=document.createElement("button");s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zoom-in"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>',o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zoom-out"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="8" x2="14" y1="11" y2="11"/></svg>',r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>',s.title="Zoom in",o.title="Zoom out",r.title="Reset view",a.title="Center tree";[s,o,r,a].forEach((t=>{t.style.cssText="\n\t\tmargin: 4px;\n\t\tpadding: 4px 6px;\n\t\tfont-size: 12px;\n\t\tbackground:rgb(246, 238, 226, 0.5);\n\t\tbox-shadow: 0 2px 5px rgba(0,0,0,0.1);\n\t\tcolor: black;\n\t\tborder: none;\n\t\tborder-radius: 5px;\n\t\tcursor: pointer;\n\t\topacity: 0.3;\n\t\ttransition: opacity 0.2s ease-in-out;\n\t  ",t.onmouseenter=()=>{t.style.opacity="0.9"},t.onmouseleave=()=>{t.style.opacity="0.3"}})),s.onclick=t,o.onclick=e,r.onclick=n,a.onclick=i;const d=document.createElement("div");this.container.style.position="relative",d.style.cssText="\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tgap: 5px;\n\t\tjustify-content: center;\n\t\twidth: 100%;\n\t\tposition: absolute;\n\t\ttop: 5px;\n\t\tright: 5px;\n\t\twidth: 40px;\n\t\tz-index: 100;\n\t\tpointer-events: auto;\n\t\ttransition: opacity 0.3s ease-in-out, transform 0.3s ease;\n\t  ",d.append(s,o,r,a),this.container.append(d)}}class a{constructor(t,e,n){this.nodeMap=new Map,this.scale=1,this.options=t,this.svg=e,this.connectionRenderer=n}setNodeMap(t){this.nodeMap=t}enableNodeDragging(t){if(!this.options.nodeDraggable)return;const e=t.current_node_element,n=`drag_cleanup_${t.id}`;e[n]&&e[n]();let i=!1,s=0,o=0;const r=t=>{if(t.target instanceof Element&&t.target.closest(".collapse-btn"))return;t.preventDefault(),t.stopPropagation(),i=!0,s=t.clientX,o=t.clientY,e.classList.add("dragging");const n=e.parentNode;n&&n.appendChild(e)},a=n=>{if(!i)return;const r=(n.clientX-s)/1,a=(n.clientY-o)/1;void 0!==t.x&&void 0!==t.y&&(t.manuallyPositioned=!0,t.x+=r,t.y+=a,e.setAttribute("transform",`translate(${t.x}, ${t.y})`),this.connectionRenderer.updateConnections(t,this.nodeMap,this.svg)),s=n.clientX,o=n.clientY},d=()=>{i&&(i=!1,e.classList.remove("dragging"))};e.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",d),e[n]=()=>{e.removeEventListener("mousedown",r),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)}}setScale(t){this.scale=t}}class d{constructor(d){this.treeBounds={minX:0,minY:0,maxX:0,maxY:0},this.options={...t,...d},this.treeBuilder=new e(this.options),this.backgroundRenderer=new n(this.options),this.connectionRenderer=new i(this.options),this.layoutEngine=new o(this.options),this.nodes=this.treeBuilder.buildTree(this.options.data||[]),this._renderSVG(),this.nodeRenderer=new s(this.options,this.connectionRenderer,this.treeBuilder),this.dragManager=new a(this.options,this.svg,this.connectionRenderer),this.eventManager=new h(this.svg,this.group),this.uiController=new r(this.options),this._setupEventHandlers(),this._renderTree(),this.centerTree()}_renderSVG(){const t=document.getElementById(this.options.containerId);if(!t)throw new Error(`Container with ID "${this.options.containerId}" not found`);t.innerHTML="";const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.style.background=this.options.backgroundColor||"#f9f9f9",this.backgroundRenderer.applyBackgroundPattern(e),this.group=document.createElementNS("http://www.w3.org/2000/svg","g"),this.group.setAttribute("id","panZoomGroup"),e.appendChild(this.group),t.appendChild(e),this.svg=e}_setupEventHandlers(){this.uiController.renderActionButtons((()=>this._handleZoomIn()),(()=>this._handleZoomOut()),(()=>this.resetView()),(()=>this.centerTree())),this.eventManager.attachPanAndZoomEvents(((t,e,n)=>{this._updateTransform(t,e,n),this.dragManager.setScale(t)})),this.svg.addEventListener("node:toggle-collapse",(t=>{const e=t;e.detail&&e.detail.nodeId&&this.toggleNodeCollapse(e.detail.nodeId)}))}_updateTransform(t,e,n){this.group.setAttribute("transform",`translate(${e}, ${n}) scale(${t})`)}_handleZoomIn(){const t=this.eventManager.getTransform();this.eventManager.setTransform(1.1*t.scale,t.panX,t.panY),this._updateTransform(1.1*t.scale,t.panX,t.panY)}_handleZoomOut(){const t=this.eventManager.getTransform();this.eventManager.setTransform(t.scale/1.1,t.panX,t.panY),this._updateTransform(t.scale/1.1,t.panX,t.panY)}_renderTree(){this.group.innerHTML="";const t=this.layoutEngine.layoutTree(this.nodes),e=new Map(t.map((t=>[t.id,t])));this.dragManager.setNodeMap(e),this.connectionRenderer.drawConnectionLines(t,e,this.group),this.nodeRenderer.drawNodes(t,this.group),this.options.nodeDraggable&&t.forEach((t=>{this.dragManager.enableNodeDragging(t)}));const n=this.treeBuilder.getAllNodes(this.nodes);this.treeBounds=this.layoutEngine.calculateTreeBounds(n);const i=this.eventManager.getTransform();this._updateTransform(i.scale,i.panX,i.panY)}updateData(t){this.options.data=t,this.nodes=this.treeBuilder.buildTree(t),this._renderTree(),this.centerTree()}resetView(){this.eventManager.resetView();const t=this.eventManager.getTransform();this._updateTransform(t.scale,t.panX,t.panY)}resetNodePositions(){this.treeBuilder.getAllNodes(this.nodes).forEach((t=>{t.manuallyPositioned=!1})),this._renderTree(),this.centerTree()}toggleNodeCollapse(t){const e=this.treeBuilder.getAllNodes(this.nodes).find((e=>e.id===t));e&&(e.collapsed=!e.collapsed,this._renderTree())}centerTree(){const t=this.svg.getBoundingClientRect(),e=t.width,n=t.height,i=this.treeBounds.maxX-this.treeBounds.minX,s=this.treeBounds.maxY-this.treeBounds.minY,o=e/(i+100),r=n/(s+100),a=Math.min(o,r,1),d=(e-i*a)/2-this.treeBounds.minX*a,h=(n-s*a)/2-this.treeBounds.minY*a;this.eventManager.setTransform(a,d,h),this._updateTransform(a,d,h)}zoomToFit(){if(0===this.treeBuilder.getAllNodes(this.nodes).length)return;const t=this.treeBounds.minX-50,e=this.treeBounds.minY-50,n=this.treeBounds.maxX+50,i=this.treeBounds.maxY+50,s=this.svg.getBoundingClientRect(),o=s.width,r=s.height,a=o/(n-t),d=r/(i-e),h=Math.min(a,d,1),c=(o-(n-t)*h)/2-t*h,l=(r-(i-e)*h)/2-e*h;this.eventManager.setTransform(h,c,l),this._updateTransform(h,c,l)}}class h{constructor(t,e){this.scale=1,this.panX=0,this.panY=0,this.isPanning=!1,this.startX=0,this.startY=0,this.svg=t,this.group=e}attachPanAndZoomEvents(t){this.svg.addEventListener("mousedown",(t=>{const e=t.target;e.closest(".collapse-btn")||e.closest(".drag-handle")||(this.isPanning=!0,this.startX=t.clientX-this.panX,this.startY=t.clientY-this.panY)})),this.svg.addEventListener("mousemove",(e=>{this.isPanning&&(this.panX=e.clientX-this.startX,this.panY=e.clientY-this.startY,t(this.scale,this.panX,this.panY))})),this.svg.addEventListener("mouseup",(()=>{this.isPanning=!1})),this.svg.addEventListener("mouseleave",(()=>{this.isPanning=!1})),this.svg.addEventListener("wheel",(e=>{e.preventDefault();const n=(e.deltaY>0?-1:1)>0?1.1:1/1.1,i=this.svg.getBoundingClientRect(),s=e.clientX-i.left,o=e.clientY-i.top,r=(s-this.panX)/this.scale,a=(o-this.panY)/this.scale;this.scale*=n,this.panX=s-r*this.scale,this.panY=o-a*this.scale,t(this.scale,this.panX,this.panY)}))}resetView(){this.scale=1,this.panX=50,this.panY=50}getTransform(){return{scale:this.scale,panX:this.panX,panY:this.panY}}setTransform(t,e,n){this.scale=t,this.panX=e,this.panY=n}}"undefined"!=typeof window&&(window.SVGTreeViewer=d)}();
